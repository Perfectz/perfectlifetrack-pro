trigger:
  - master

pool:
  name: Default

variables:
  - name: NODE_VERSION
    value: '20.18.1' # Keep specific version for stability
  - name: FRONTEND_NODE_MODULES_PATH
    value: 'frontend/node_modules'
  - name: BACKEND_NODE_MODULES_PATH
    value: 'backend/node_modules'

stages:
  - stage: BuildAndTest
    displayName: 'Build and Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test All'
        steps:
          # Clean workspace - Optional but can prevent issues
          # - script: |
          #     echo "Cleaning workspace..."
          #     if exist node_modules rd /s /q node_modules
          #     if exist frontend\node_modules rd /s /q frontend\node_modules
          #     if exist backend\node_modules rd /s /q backend\node_modules
          #   displayName: 'Clean workspace' # Keeping this commented for now, can re-enable if needed

          # Install Node.js using the standard task
          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js $(NODE_VERSION)'

          # Set NPM_CMD variable
          - script: |
              echo "Setting NPM_CMD variable..."
              set NPM_CMD=npm
              echo "NPM_CMD set to: %NPM_CMD%"
            displayName: 'Set NPM_CMD Variable'

          # Cache Frontend node_modules
          - task: Cache@2
            inputs:
              key: 'npm | $(Agent.OS) | frontend/package-lock.json'
              restoreKeys: |
                 npm | $(Agent.OS)
              path: $(FRONTEND_NODE_MODULES_PATH)
            displayName: Cache Frontend node_modules

          # Frontend Build
          - script: |
              cd frontend
              echo "Using Node.js at: %NODE_EXE%"
              echo "Using npm at: %NPM_CMD%"
              %NPM_CMD% ci
              %NPM_CMD% run build
            displayName: 'Build Frontend'
            workingDirectory: $(System.DefaultWorkingDirectory)

          # Frontend Test
          - script: |
              cd frontend
              %NPM_CMD% test
            displayName: 'Test Frontend'
            workingDirectory: $(System.DefaultWorkingDirectory)

          # Publish Frontend Artifacts
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'frontend/build'
              ArtifactName: 'frontend'
              publishLocation: 'Container'
            displayName: 'Publish Frontend Artifacts'

          # Cache Backend node_modules
          - task: Cache@2
            inputs:
              key: 'npm | $(Agent.OS) | backend/package-lock.json'
              restoreKeys: |
                 npm | $(Agent.OS)
              path: $(BACKEND_NODE_MODULES_PATH)
            displayName: Cache Backend node_modules

          # Backend Build
          - script: |
              cd backend
              %NPM_CMD% ci
              %NPM_CMD% run build
            displayName: 'Build Backend'
            workingDirectory: $(System.DefaultWorkingDirectory)

          # Backend Test
          - script: |
              cd backend
              %NPM_CMD% test
            displayName: 'Test Backend'
            workingDirectory: $(System.DefaultWorkingDirectory)

          # Publish Backend Artifacts
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'backend/dist' # Assuming backend build output is in 'dist'
              ArtifactName: 'backend'
              publishLocation: 'Container'
            displayName: 'Publish Backend Artifacts'

  - stage: Deploy
    displayName: 'Deploy'
    dependsOn: BuildAndTest
    condition: succeeded()
    jobs:
      - job: DeployJob
        displayName: 'Deploy Application'
        steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'specific'
              itemPattern: '**'
              downloadPath: '$(System.ArtifactsDirectory)'
            displayName: 'Download Build Artifacts'

          - script: |
              echo "Preparing deployment..."
              echo "Creating deployment directory..."
              if not exist "$(Build.ArtifactStagingDirectory)\deploy" mkdir "$(Build.ArtifactStagingDirectory)\deploy"
            displayName: 'Prepare Deployment'

          - script: |
              echo "Deploying frontend..."
              xcopy "$(System.ArtifactsDirectory)\frontend\*" "$(Build.ArtifactStagingDirectory)\deploy\frontend\" /E /I /Y
              echo "Frontend deployed successfully!"
            displayName: 'Deploy Frontend'

          - script: |
              echo "Deploying backend..."
              xcopy "$(System.ArtifactsDirectory)\backend\*" "$(Build.ArtifactStagingDirectory)\deploy\backend\" /E /I /Y
              echo "Backend deployed successfully!"
            displayName: 'Deploy Backend'

          - script: |
              echo "Deployment verification..."
              echo "Checking deployment files..."
              dir "$(Build.ArtifactStagingDirectory)\deploy" /s
              echo "Deployment complete and verified!"
            displayName: 'Verify Deployment'
